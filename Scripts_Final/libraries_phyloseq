library(readxl)
library(phyloseq)
library(ape)
library(tidyverse)
library(picante)
library(vegan)
# install.packages("indicspecies")
library(microbiome)
library(ggVennDiagram)
library(indicspecies)
library(DESeq2)
library(ggplot2)
library(dplyr)
library(tibble)
library(ggrepel)
library(stringr)

library(randomForest)
library(caret)
library(ranger)
library(pROC)
library(boot)

#### 1A. Load metadata ####
meta_fp <- "ms_metadata_corrected.xlsx"
meta <- read_xlsx(meta_fp)
# Create age of onset column
meta <- meta %>%
  mutate(
    # make sure both are numeric
    age_at_sample          = as.numeric(age),
    disease_duration_years = as.numeric(disease_duration),
    
    # derive onset age
    onset_age = age_at_sample - disease_duration_years
  ) %>%
  # 1) Drop truly missing onset_age
  filter(!is.na(onset_age)) %>%
  # 2) Drop onset ages outside your adult-onset window
  filter(onset_age >= 18) %>%   # <= this is what fixes the extra NAs
  mutate(
    onset_age_group = cut(
      onset_age,
      breaks = c(18, 29, 49, Inf),
      labels = c("18-29","30-49","50+"),
      right  = TRUE,
      include.lowest = TRUE
    )
  )
#### 1A. Load OTU / feature table ####
otu_fp <- "feature-table.txt"
otu <- read_delim(otu_fp, delim = "\t", skip = 1)

# Convert OTU table to matrix with taxa as rows, samples as columns
otu_mat <- as.matrix(otu[ , -1])
rownames(otu_mat) <- otu$`#OTU ID`
OTU <- otu_table(otu_mat, taxa_are_rows = TRUE)

#### 1A. Format sample metadata ####
samp_df <- as.data.frame(meta[ , -1])
rownames(samp_df) <- meta$`sample-id`
SAMP <- sample_data(samp_df)

#### 1A. Load taxonomy ####
tax_fp <- "taxonomy.tsv"
tax <- read_delim(tax_fp, delim = "\t")

tax_mat <- tax %>%
  select(-Confidence) %>%
  separate(
    col   = Taxon,
    sep   = "; ",
    into  = c("Domain","Phylum","Class","Order","Family","Genus","Species")
  ) %>%
  as.matrix()

tax_mat <- tax_mat[ , -1]                     # drop Feature ID column
rownames(tax_mat) <- tax$`Feature ID`
TAX <- tax_table(tax_mat)

#### 1A. Load phylogenetic tree ####
tree_fp <- "tree.nwk"
phylotree <- read.tree(tree_fp)

#### 1A. Build unified phyloseq object ####
ms_ps <- phyloseq(OTU, SAMP, TAX, phylotree)
